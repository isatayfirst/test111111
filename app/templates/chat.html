<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ß–∞—Ç</title>

    <!---- –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
    <link rel="stylesheet" href="/static/styles.css">

    <!---- —á—É—Ç—å-—á—É—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ ‚Äú–≥–ª—è–Ω—Ü–∞‚Äù —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–∞ -->
    <style>
        body{height:100vh;flex-direction:column;}

        /* –±–æ–∫–æ–≤–∞—è —Ç–µ–Ω—å —É –ø–∞–Ω–µ–ª–∏ –≤–≤–æ–¥–∞ */
        #sendArea{box-shadow:0 -1px 4px rgba(0,0,0,.04);}
        /* –≥—Ä–∞–¥–∏–µ–Ω—Ç –ø—É–∑—ã—Ä–µ–π –æ—Ç —Å–µ–±—è */
        .me{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-dark) 100%);}
        .me time{color:#d1d5ff;}
        /* ¬´—Å–µ—Ä—ã–π¬ª –ø—É–∑—ã—Ä—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ */
        .other{background:#e5e7eb;}
        .other time{color:#6b7280;}
        /* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π timestamp */
        .msg{position:relative;padding-bottom:24px;}
        time{
            position:absolute;right:12px;bottom:4px;
            font-size:11px;font-weight:500;
            user-select:none;
        }
    </style>
</head>
<body class="chat-page">

<div class="chat-wrapper">
<!---- —à–∞–ø–∫–∞ ---->
<header style="padding:18px 24px;background:var(--card);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0;">üí¨ –ß–∞—Ç</h3>
    <button style="width:auto;padding:8px 14px;" onclick="logout()">–í—ã–π—Ç–∏</button>
</header>

<!---- –≤—ã–±–æ—Ä —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ ---->
<div style="padding:14px 24px;background:var(--bg-100);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
    <label style="font-size:14px;color:var(--text-light);">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</label>
    <select id="receiver" onchange="loadHistory()" style="max-width:220px;"></select>
</div>

<!---- –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π ---->
<div id="messages"></div>

<!---- –≤–≤–æ–¥ ---->
<div id="sendArea">
    <input id="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" onkeydown="if(event.key==='Enter') send()">
    <button style="width:auto;padding:10px 16px;" onclick="send()">‚û§</button>
</div>

<script>
/* ---------- –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ---------- */
const token = localStorage.getItem("token");
if (!token){ location.href="/"; }

/* ---------- –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---------- */
let socket        = null;
let currentUserId = null;      // —É–∑–Ω–∞—ë–º –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ ‚Äú.me‚Äù

/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);

/* ---------- –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ id ---------- */
(async () => {
    const payload = JSON.parse(atob(token.split(".")[1]));
    const username = payload.sub;

    const resp = await fetch("/auth/users");
    const users = await resp.json();
    const me    = users.find(u => u.username === username);
    currentUserId = me.id;

    // –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç
    const r = $("receiver");
    r.innerHTML = "<option disabled selected>‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>";
    users
        .filter(u => u.id !== currentUserId)
        .forEach(u => {
            const o = document.createElement("option");
            o.value = u.id; o.textContent = u.username;
            r.appendChild(o);
        });

    // —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å WS
    connect();
})();

/* ---------- WebSocket ---------- */
function connect(){
    socket = new WebSocket(`ws://${location.host}/ws/chat?token=${token}`);

    socket.onopen    = () => console.log("WS connected");
    socket.onclose   = () => alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
    socket.onerror   = e  => console.error("WS error", e);
    socket.onmessage = e  => addMsg(e.data);
}

/* ---------- –∏—Å—Ç–æ—Ä–∏—è ---------- */
async function loadHistory(){
    const withId = +$("receiver").value;
    if(!withId) return;
    const resp = await fetch(`/history/${withId}`,{
        headers:{Authorization:"Bearer "+token}
    });
    if(!resp.ok){ alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"); return; }
    const history = await resp.json();
    $("messages").innerHTML = "";            // –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
    history.forEach(m => renderBubble(m.content, m.sender_id===currentUserId, m.timestamp));
    scrollBottom();
}

/* ---------- –æ—Ç–ø—Ä–∞–≤–∫–∞ ---------- */
function send(){
    const txt = $("text").value.trim();
    const to  = +$("receiver").value;
    if(!txt || !to){ return; }
    socket.send(JSON.stringify({receiver_id: to, content: txt}));
    $("text").value = "";
    // —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ
    renderBubble(txt,true,new Date().toISOString());
    scrollBottom();
}

/* ---------- –≤–∏–∑—É–∞–ª –ø—É–∑—ã—Ä—è ---------- */
function renderBubble(text,isMe,timestampISO){
    const wrap = document.createElement("div");
    wrap.className = `msg ${isMe?"me":"other"}`;
    wrap.innerHTML = `${text}<time>${new Date(timestampISO).toLocaleTimeString().slice(0,5)}</time>`;
    $("messages").appendChild(wrap);
}

function addMsg(raw){
    // —Ñ–æ—Ä–º–∞—Ç: "username: message"
    const split = raw.indexOf(":");
    const uname = raw.slice(0,split);
    const msg   = raw.slice(split+2);
    renderBubble(msg,false,new Date().toISOString());
    scrollBottom();
}

function scrollBottom(){
    const m = $("messages");
    m.scrollTop = m.scrollHeight;
}

function logout(){
    localStorage.clear();
    location.href="/";
}
</script>
</div>
</body>
</html>
